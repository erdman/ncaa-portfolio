<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- datatables.net bootstrap4 styling -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">

    <!-- Custom styles for the large space filling tables, taken from an example on datatables.net -->
    <style type="text/css">
        #leaderboard_div {
            position: absolute;
            top: 3em;
            left: 1em;
            right: 1em;
            bottom: 1em;
        }

        #Summary {
            position: absolute;
            top: 3em;
            left: 1em;
            right: 1em;
            bottom: 1em;
        }

        #Details {
            position: absolute;
            top: 3em;
            left: 1em;
            right: 1em;
            bottom: 1em;
        }

    </style>
  </head>
  <body>
    <div>
      <ul class="nav nav-pills nav-justified">
        <li class="nav-item">
            <a class="navbar-brand" href="#">NCAAportfolio.com</a>
        </li>
        <li class="nav-item">
            <a class='nav-link active' data-toggle="tab" href="#leaderboard_div">Leaderboard</a>
        </li>
        <li class="nav-item">
            <a class='nav-link' data-toggle="tab" href="#Summary">Summary</a>
        </li>
        <li class="nav-item">
            <a class='nav-link' data-toggle="tab" href="#Details">Details</a>
        </li>
        <li class="nav-item">
            <a class='nav-link' data-toggle="tab" href="#Champions">Champions</a>
        </li>
        <li class="nav-item">
<!--
          <a class="nav-link" data-toggle="tab" href="#Year">Year</a>
-->
          <select class="nav-link" style="float: right; background-color: white">
            <option>2017</option>
            <option>2016</option>
          </select>
        </li>
        <li class="nav-item">
            <form class="form-inline my-2 my-lg-0">
                <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search" id='search'>
            </form>
        </li>
      </ul>
    </div>

    <main role="main" class="tab-content">
        <div id="Summary" class="tab-pane fade in">
            <table id="summary_table" class="display nowrap table table-striped table-bordered" cellspacing="0" width="100%">
                <tfoot>
                    <tr>
                        <th>Name</th>
                        <th>Conference</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>10</th>
                        <th>11</th>
                        <th>12</th>
                        <th>13</th>
                        <th>14</th>
                        <th>15</th>
                        <th>16</th>
                        <th>Total</th>
                        <th>Units</th>
                        <th>Points / Unit</th>
                     </tr>
                </tfoot>
            </table>
        </div>
        <div id="Details" class="tab-pane fade in">
            <table id="details_table" class="display nowrap table table-striped table-bordered" cellspacing="0" width="100%">
                <tfoot>
                    <tr>
                        <th>Date</th>
                        <th>Week</th>
                        <th>Result</th>
                     </tr>
                </tfoot>
            </table>
        </div>
        <div id="Champions" class="tab-pane fade in">
            <table id="champions_table" class="display nowrap table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Champion</th>
                     </tr>
                </thead>

                <tbody>
                    <tr>
                        <td>2017</td>
                        <td>Travis Erdman</td>
                    </tr>
                    <tr>
                        <td>2016</td>
                        <td>Jason Kopka</td>
                    </tr>
                    <tr>
                        <td>2015</td>
                        <td>Travis Erdman</td>
                    </tr>
                    <tr>
                        <td>2014</td>
                        <td>Steve Schubert</td>
                    </tr>
                    <tr>
                        <td>2013</td>
                        <td>TJ Nolan</td>
                    </tr>
                    <tr>
                        <td>2012</td>
                        <td>Tony Andronaco</td>
                    </tr>
                    <tr>
                        <td>2011</td>
                        <td>TJ Nolan</td>
                    </tr>

                </tbody>
            </table>
        </div>

        <div id="leaderboard_div" class="tab-pane active fade in show" >
            <table id="leaderboard_table" class="display nowrap table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Position</th>
                        <th>Office</th>
                        <th>Age</th>
                        <th>Start date</th>
                        <th>Salary</th>
                    </tr>
                </thead>

                <tfoot>
                    <tr>
                        <th>Name</th>
                        <th>Position</th>
                        <th>Office</th>
                        <th>Age</th>
                        <th>Start date</th>
                        <th>Salary</th>
                    </tr>
                </tfoot>

                <tbody>
                    <tr>
                        <td>Tiger Nixon</td>
                        <td>System Architect</td>
                        <td>Edinburgh</td>
                        <td>61</td>
                        <td>2011/04/25</td>
                        <td>$320,800</td>
                    </tr>
                    <tr>
                        <td>Garrett Winters</td>
                        <td>Accountant</td>
                        <td>Tokyo</td>
                        <td>63</td>
                        <td>2011/07/25</td>
                        <td>$170,750</td>
                    </tr>
                    <tr>
                        <td>Ashton Cox</td>
                        <td>Junior Technical Author</td>
                        <td>San Francisco</td>
                        <td>66</td>
                        <td>2009/01/12</td>
                        <td>$86,000</td>
                    </tr>
                    <tr>
                        <td>Cedric Kelly</td>
                        <td>Senior Javascript Developer</td>
                        <td>Edinburgh</td>
                        <td>22</td>
                        <td>2012/03/29</td>
                        <td>$433,060</td>
                    </tr>
                    <tr>
                        <td>Airi Satou</td>
                        <td>Accountant</td>
                        <td>Tokyo</td>
                        <td>33</td>
                        <td>2008/11/28</td>
                        <td>$162,700</td>
                    </tr>
                    <tr>
                        <td>Brielle Williamson</td>
                        <td>Integration Specialist</td>
                        <td>New York</td>
                        <td>61</td>
                        <td>2012/12/02</td>
                        <td>$372,000</td>
                    </tr>
                    <tr>
                        <td>Herrod Chandler</td>
                        <td>Sales Assistant</td>
                        <td>San Francisco</td>
                        <td>59</td>
                        <td>2012/08/06</td>
                        <td>$137,500</td>
                    </tr>
                    <tr>
                        <td>Rhona Davidson</td>
                        <td>Integration Specialist</td>
                        <td>Tokyo</td>
                        <td>55</td>
                        <td>2010/10/14</td>
                        <td>$327,900</td>
                    </tr>
                    <tr>
                        <td>Colleen Hurst</td>
                        <td>Javascript Developer</td>
                        <td>San Francisco</td>
                        <td>39</td>
                        <td>2009/09/15</td>
                        <td>$205,500</td>
                    </tr>
                    <tr>
                        <td>Sonya Frost</td>
                        <td>Software Engineer</td>
                        <td>Edinburgh</td>
                        <td>23</td>
                        <td>2008/12/13</td>
                        <td>$103,600</td>
                    </tr>
                    <tr>
                        <td>Jena Gaines</td>
                        <td>Office Manager</td>
                        <td>London</td>
                        <td>30</td>
                        <td>2008/12/19</td>
                        <td>$90,560</td>
                    </tr>
                    <tr>
                        <td>Quinn Flynn</td>
                        <td>Support Lead</td>
                        <td>Edinburgh</td>
                        <td>22</td>
                        <td>2013/03/03</td>
                        <td>$342,000</td>
                    </tr>
                    <tr>
                        <td>Charde Marshall</td>
                        <td>Regional Director</td>
                        <td>San Francisco</td>
                        <td>36</td>
                        <td>2008/10/16</td>
                        <td>$470,600</td>
                    </tr>
                    <tr>
                        <td>Haley Kennedy</td>
                        <td>Senior Marketing Designer</td>
                        <td>London</td>
                        <td>43</td>
                        <td>2012/12/18</td>
                        <td>$313,500</td>
                    </tr>
                    <tr>
                        <td>Tatyana Fitzpatrick</td>
                        <td>Regional Director</td>
                        <td>London</td>
                        <td>19</td>
                        <td>2010/03/17</td>
                        <td>$385,750</td>
                    </tr>
                    <tr>
                        <td>Michael Silva</td>
                        <td>Marketing Designer</td>
                        <td>London</td>
                        <td>66</td>
                        <td>2012/11/27</td>
                        <td>$198,500</td>
                    </tr>
                    <tr>
                        <td>Paul Byrd</td>
                        <td>Chief Financial Officer (CFO)</td>
                        <td>New York</td>
                        <td>64</td>
                        <td>2010/06/09</td>
                        <td>$725,000</td>
                    </tr>
                    <tr>
                        <td>Gloria Little</td>
                        <td>Systems Administrator</td>
                        <td>New York</td>
                        <td>59</td>
                        <td>2009/04/10</td>
                        <td>$237,500</td>
                    </tr>
                    <tr>
                        <td>Bradley Greer</td>
                        <td>Software Engineer</td>
                        <td>London</td>
                        <td>41</td>
                        <td>2012/10/13</td>
                        <td>$132,000</td>
                    </tr>
                    <tr>
                        <td>Dai Rios</td>
                        <td>Personnel Lead</td>
                        <td>Edinburgh</td>
                        <td>35</td>
                        <td>2012/09/26</td>
                        <td>$217,500</td>
                    </tr>
                    <tr>
                        <td>Jenette Caldwell</td>
                        <td>Development Lead</td>
                        <td>New York</td>
                        <td>30</td>
                        <td>2011/09/03</td>
                        <td>$345,000</td>
                    </tr>
                    <tr>
                        <td>Yuri Berry</td>
                        <td>Chief Marketing Officer (CMO)</td>
                        <td>New York</td>
                        <td>40</td>
                        <td>2009/06/25</td>
                        <td>$675,000</td>
                    </tr>
                    <tr>
                        <td>Caesar Vance</td>
                        <td>Pre-Sales Support</td>
                        <td>New York</td>
                        <td>21</td>
                        <td>2011/12/12</td>
                        <td>$106,450</td>
                    </tr>
                    <tr>
                        <td>Doris Wilder</td>
                        <td>Sales Assistant</td>
                        <td>Sidney</td>
                        <td>23</td>
                        <td>2010/09/20</td>
                        <td>$85,600</td>
                    </tr>
                    <tr>
                        <td>Angelica Ramos</td>
                        <td>Chief Executive Officer (CEO)</td>
                        <td>London</td>
                        <td>47</td>
                        <td>2009/10/09</td>
                        <td>$1,200,000</td>
                    </tr>
                    <tr>
                        <td>Gavin Joyce</td>
                        <td>Developer</td>
                        <td>Edinburgh</td>
                        <td>42</td>
                        <td>2010/12/22</td>
                        <td>$92,575</td>
                    </tr>
                    <tr>
                        <td>Jennifer Chang</td>
                        <td>Regional Director</td>
                        <td>Singapore</td>
                        <td>28</td>
                        <td>2010/11/14</td>
                        <td>$357,650</td>
                    </tr>
                    <tr>
                        <td>Brenden Wagner</td>
                        <td>Software Engineer</td>
                        <td>San Francisco</td>
                        <td>28</td>
                        <td>2011/06/07</td>
                        <td>$206,850</td>
                    </tr>
                    <tr>
                        <td>Fiona Green</td>
                        <td>Chief Operating Officer (COO)</td>
                        <td>San Francisco</td>
                        <td>48</td>
                        <td>2010/03/11</td>
                        <td>$850,000</td>
                    </tr>
                    <tr>
                        <td>Shou Itou</td>
                        <td>Regional Marketing</td>
                        <td>Tokyo</td>
                        <td>20</td>
                        <td>2011/08/14</td>
                        <td>$163,000</td>
                    </tr>
                    <tr>
                        <td>Michelle House</td>
                        <td>Integration Specialist</td>
                        <td>Sidney</td>
                        <td>37</td>
                        <td>2011/06/02</td>
                        <td>$95,400</td>
                    </tr>
                    <tr>
                        <td>Suki Burks</td>
                        <td>Developer</td>
                        <td>London</td>
                        <td>53</td>
                        <td>2009/10/22</td>
                        <td>$114,500</td>
                    </tr>
                    <tr>
                        <td>Prescott Bartlett</td>
                        <td>Technical Author</td>
                        <td>London</td>
                        <td>27</td>
                        <td>2011/05/07</td>
                        <td>$145,000</td>
                    </tr>
                    <tr>
                        <td>Gavin Cortez</td>
                        <td>Team Leader</td>
                        <td>San Francisco</td>
                        <td>22</td>
                        <td>2008/10/26</td>
                        <td>$235,500</td>
                    </tr>
                    <tr>
                        <td>Martena Mccray</td>
                        <td>Post-Sales support</td>
                        <td>Edinburgh</td>
                        <td>46</td>
                        <td>2011/03/09</td>
                        <td>$324,050</td>
                    </tr>
                    <tr>
                        <td>Unity Butler</td>
                        <td>Marketing Designer</td>
                        <td>San Francisco</td>
                        <td>47</td>
                        <td>2009/12/09</td>
                        <td>$85,675</td>
                    </tr>
                    <tr>
                        <td>Howard Hatfield</td>
                        <td>Office Manager</td>
                        <td>San Francisco</td>
                        <td>51</td>
                        <td>2008/12/16</td>
                        <td>$164,500</td>
                    </tr>
                    <tr>
                        <td>Hope Fuentes</td>
                        <td>Secretary</td>
                        <td>San Francisco</td>
                        <td>41</td>
                        <td>2010/02/12</td>
                        <td>$109,850</td>
                    </tr>
                    <tr>
                        <td>Vivian Harrell</td>
                        <td>Financial Controller</td>
                        <td>San Francisco</td>
                        <td>62</td>
                        <td>2009/02/14</td>
                        <td>$452,500</td>
                    </tr>
                    <tr>
                        <td>Timothy Mooney</td>
                        <td>Office Manager</td>
                        <td>London</td>
                        <td>37</td>
                        <td>2008/12/11</td>
                        <td>$136,200</td>
                    </tr>
                    <tr>
                        <td>Jackson Bradshaw</td>
                        <td>Director</td>
                        <td>New York</td>
                        <td>65</td>
                        <td>2008/09/26</td>
                        <td>$645,750</td>
                    </tr>
                    <tr>
                        <td>Olivia Liang</td>
                        <td>Support Engineer</td>
                        <td>Singapore</td>
                        <td>64</td>
                        <td>2011/02/03</td>
                        <td>$234,500</td>
                    </tr>
                    <tr>
                        <td>Bruno Nash</td>
                        <td>Software Engineer</td>
                        <td>London</td>
                        <td>38</td>
                        <td>2011/05/03</td>
                        <td>$163,500</td>
                    </tr>
                    <tr>
                        <td>Sakura Yamamoto</td>
                        <td>Support Engineer</td>
                        <td>Tokyo</td>
                        <td>37</td>
                        <td>2009/08/19</td>
                        <td>$139,575</td>
                    </tr>
                    <tr>
                        <td>Thor Walton</td>
                        <td>Developer</td>
                        <td>New York</td>
                        <td>61</td>
                        <td>2013/08/11</td>
                        <td>$98,540</td>
                    </tr>
                    <tr>
                        <td>Finn Camacho</td>
                        <td>Support Engineer</td>
                        <td>San Francisco</td>
                        <td>47</td>
                        <td>2009/07/07</td>
                        <td>$87,500</td>
                    </tr>
                    <tr>
                        <td>Serge Baldwin</td>
                        <td>Data Coordinator</td>
                        <td>Singapore</td>
                        <td>64</td>
                        <td>2012/04/09</td>
                        <td>$138,575</td>
                    </tr>
                    <tr>
                        <td>Zenaida Frank</td>
                        <td>Software Engineer</td>
                        <td>New York</td>
                        <td>63</td>
                        <td>2010/01/04</td>
                        <td>$125,250</td>
                    </tr>
                    <tr>
                        <td>Zorita Serrano</td>
                        <td>Software Engineer</td>
                        <td>San Francisco</td>
                        <td>56</td>
                        <td>2012/06/01</td>
                        <td>$115,000</td>
                    </tr>
                    <tr>
                        <td>Jennifer Acosta</td>
                        <td>Junior Javascript Developer</td>
                        <td>Edinburgh</td>
                        <td>43</td>
                        <td>2013/02/01</td>
                        <td>$75,650</td>
                    </tr>
                    <tr>
                        <td>Cara Stevens</td>
                        <td>Sales Assistant</td>
                        <td>New York</td>
                        <td>46</td>
                        <td>2011/12/06</td>
                        <td>$145,600</td>
                    </tr>
                    <tr>
                        <td>Hermione Butler</td>
                        <td>Regional Director</td>
                        <td>London</td>
                        <td>7</td>
                        <td>2011/03/21</td>
                        <td>$356,250</td>
                    </tr>
                    <tr>
                        <td>Lael Greer</td>
                        <td>Systems Administrator</td>
                        <td>London</td>
                        <td>21</td>
                        <td>2009/02/27</td>
                        <td>$103,500</td>
                    </tr>
                    <tr>
                        <td>Jonas Alexander</td>
                        <td>Developer</td>
                        <td>San Francisco</td>
                        <td>3</td>
                        <td>2010/07/14</td>
                        <td>$86,500</td>
                    </tr>
                    <tr>
                        <td>Shad Decker</td>
                        <td>Regional Director</td>
                        <td>Edinburgh</td>
                        <td>1</td>
                        <td>2008/11/13</td>
                        <td>$183,000</td>
                    </tr>
                    <tr>
                        <td>Michael Bruce</td>
                        <td>Javascript Developer</td>
                        <td>Singapore</td>
                        <td>29</td>
                        <td>2011/06/27</td>
                        <td>$183,000</td>
                    </tr>
                    <tr>
                        <td>Donna Snider</td>
                        <td>Customer Support</td>
                        <td>New York</td>
                        <td>27</td>
                        <td>2011/01/25</td>
                        <td>$112,000</td>
                    </tr>
                </tbody>
            </table>
        </div>



    </main> <!-- /.container -->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
<!--
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
-->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/plug-ins/1.10.16/features/scrollResize/dataTables.scrollResize.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        'use strict';
        function _stringifyGame(winner, loser, game) {
             //~ a-tag syntax: <a href="https://www.w3schools.com">Visit W3Schools.com!</a>
            return `<a href="https://www.ncaa.com${game.url}">${(winner.teamRank > 0) ? '#' + winner.teamRank + ' ' : ''}${winner.nameRaw} ${winner.currentScore}, ${(loser.teamRank > 0) ? '#' + loser.teamRank + ' ' : ''}${loser.nameRaw} ${loser.currentScore}<\a>`;
        }
        function stringifyGame(game) {
            return (game.away.currentScore > game.home.currentScore) ? _stringifyGame(game.away, game.home, game) : _stringifyGame(game.home, game.away, game);
        }
        // win_points indexed on [WIN?][OPP FBS?]
        const win_points = {true: {true: 10, false: 0}, false: {true: 0, false: -10}};
        // top25_points indexed on [WIN?][RANKED BETTER?][ABS(RANK_HI - RANK_LO) unless win and oppo unranked then return 0]
        const top25_points = {true:  {false: [0,5,5,5,5,6,6,6,6,6,6,6,6,6,6,8,8,8,8,8,8,8,8,8,8,10], true: [0,4,4,4,4,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,0]},
                              false: {false: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],  true: [0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-3,-3,-3,-3,-3,-3,-5,-5,-5,-5,-5]}
        };
        function calculateScore(hero, villain, fbs_name_set, game, new_years_six) {
            let heroRank = hero.teamRank > 0 ? hero.teamRank : 26;
            let villainRank = villain.teamRank > 0 ? villain.teamRank : 26;
            let VILLAIN_FBS = fbs_name_set.has(villain.nameRaw);
            let score = {win: win_points[hero.currentScore > villain.currentScore][VILLAIN_FBS],
                         blowout: VILLAIN_FBS && (hero.currentScore - villain.currentScore >= 30) ? 2 : 0,
                         shutout: VILLAIN_FBS && villain.currentScore === 0 ? 4 : 0,
                         top25: top25_points[hero.currentScore > villain.currentScore][heroRank < villainRank][hero.currentScore > villain.currentScore && villainRank === 26 ? 0 : Math.abs(heroRank - villainRank)],
                         bowl:  (game.week === 16 && !new_years_six.championships.has(game.id) ? 10 : 0) +
                                (new_years_six.playoffs.has(game.id) ? 6 : 0) +
                                (new_years_six.new_years_fours.has(game.id) ? 3 : 0)
            };
            score.total = score.win + score.blowout + score.shutout + score.top25 + score.bowl;
            return score;
        }


        let games = [], portfolios = [], schools = {};
        const weeks = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16];
        const year = 2017;

        let loaders = weeks.map(function (week) {
            return $.getJSON(`json/${year}/${year}${week.toString().padStart(2,'0')}.json`)
                .then(function (data) {
                    games.push(...data.map(function (game) {
                        game.week = week;
                        return game;
                    }));
                }, function () { // in case of error (ie file not found), just return as resolved ala https://stackoverflow.com/a/30219952
                    return $.Deferred().resolve({}).promise();
                }
            );
        });


        let fbs, fbs_name_set, new_years_six = {};

        loaders.push(
            $.getJSON('json/fbs-2017.json')
            .then(function (data) {
                fbs = data.reduce((obj, cur) => { return { ...obj, [cur.name]: cur }; }, {});  //convert array to object indexed by names
                fbs_name_set = new Set(data.map(x => x.name));
            })
        );

        loaders.push(
            $.getJSON('json/new-years-six.json')
            .then(function (data) {
                Object.keys(data).forEach(function(key) {
                    new_years_six[key] = new Set(data[key]);
                });
            })
        );

        loaders.push(
            $.getJSON('json/portfolios-2017.json')
            .then(function (data) {
                portfolios.push(...data.map(function (portfolio) {
                    let result = [portfolio.Name];
                    delete portfolio.Name;
                    result.push(Object.values(portfolio).filter(item => item.length > 0));
                    return result;
                }));
            })
        );


        $.when(...loaders
        ).then(function () {
            games.sort((a, b) => a.startDate.localeCompare(b.startDate));
            console.log('when...then');
            console.log(games.length);
            console.log(games);
            console.log(fbs);
            console.log(fbs_name_set);
            console.log(new_years_six);
            console.log(portfolios);
            games.forEach(function(game) {
                // parse JSON integers and trim name strings
                game.home.teamRank = parseInt(game.home.teamRank, 10);
                game.home.currentScore = parseInt(game.home.currentScore, 10);
                game.home.nameRaw = game.home.nameRaw.trim();
                game.away.teamRank = parseInt(game.away.teamRank, 10);
                game.away.currentScore = parseInt(game.away.currentScore, 10);
                game.away.nameRaw = game.away.nameRaw.trim();
                game.id = parseInt(game.id, 10);
                game.score_string = stringifyGame(game);

                if (game.gameState === 'final') {
                    if (fbs_name_set.has(game.away.nameRaw)) {
                        if (! schools.hasOwnProperty(game.away.nameRaw)) {
                            schools[game.away.nameRaw] = {games : [], points: 0};
                        }
                        let score = calculateScore(game.away, game.home, fbs_name_set, game, new_years_six);
                        score.date = game.startDate;
                        score.score_string = game.score_string;
                        schools[game.away.nameRaw].games.push(score);
                        schools[game.away.nameRaw].points += score.total;
                    }

                    if (fbs_name_set.has(game.home.nameRaw)) {
                        if (! schools.hasOwnProperty(game.home.nameRaw)) {
                            schools[game.home.nameRaw] = {games : [], points: 0};
                        }
                        let score = calculateScore(game.home, game.away, fbs_name_set, game, new_years_six);
                        score.date = game.startDate;
                        score.score_string = game.score_string;
                        schools[game.home.nameRaw].games.push(score);
                        schools[game.home.nameRaw].points += score.total;
                    }
                }
            });
            console.log(schools);

            $('#details_table').DataTable( {
                data: games.filter(game => game.gameState === 'final'),
                columns: [
                    { "data": "startDate", "title": "Date" },
                    { "data": "week", "title": "Week" },
                    { "data": "score_string", "title": "Result" }
                    ],
                "dom": 'lrtip',         <!-- removes the native search input box-->
                scrollResize: true,
                scrollX: true,
                scrollY: 100,
                scrollCollapse: true,
                paging: false,
                lengthChange: false
            });

            $('#summary_table').DataTable( {
                data: Object.keys(schools).map(function (school) { return { 'name': school,
                                                                            'conference': fbs[school].conference,
                                                                            'weeklies': schools[school].games.map(score => score.total),
                                                                            'points': schools[school].points,
                                                                            'units':  fbs[school].units,
                                                                            'points-per':  schools[school].points / fbs[school].units
                                                                            };
                                                                 }
                                               ),
                columns: [
                    { "data": "name", "title": "Name" },
                    { "data": "conference", "title": "Conference" },
                    { "data": "weeklies.0", "title": "1", className: "text-right" },
                    { "data": "weeklies.1", "title": "2", className: "text-right" },
                    { "data": "weeklies.2", "title": "3", className: "text-right" },
                    { "data": "weeklies.3", "title": "4", className: "text-right" },
                    { "data": "weeklies.4", "title": "5", className: "text-right" },
                    { "data": "weeklies.5", "title": "6", className: "text-right" },
                    { "data": "weeklies.6", "title": "7", className: "text-right" },
                    { "data": "weeklies.7", "title": "8", className: "text-right" },
                    { "data": "weeklies.8", "title": "9", className: "text-right" },
                    { "data": "weeklies.9", "title": "10", className: "text-right" },
                    { "data": "weeklies.10", "title": "11", className: "text-right" },
                    { "data": "weeklies.11", "title": "12", className: "text-right" },
                    { "data": "weeklies.12", "title": "13", className: "text-right" },
                    { "data": "weeklies.13", "title": "14", className: "text-right" },
                    { "data": "weeklies.14", "title": "15", className: "text-right" },
                    { "data": "weeklies.15", "title": "16", className: "text-right" },
                    { "data": "points", "title": "Total", className: "text-right" },
                    { "data": "units", "title": "Units", className: "text-right" },
                    { "data": "points-per", "title": "Points / Unit", className: "text-right", render: $.fn.dataTable.render.number( ',', '.', 2 ) }
                    ],
                "dom": 'lrtip',         <!-- removes the native search input box-->
                scrollResize: true,
                scrollX: true,
                scrollY: 100,
                scrollCollapse: true,
                paging: false,
                lengthChange: false
            });
        });

        $(document).ready( function () {
            // DataTables initialisation
            var table = $('#leaderboard_table').DataTable( {
                "dom": 'lrtip',         <!-- removes the native search input box-->
                scrollResize: true,
                scrollX: true,
                scrollY: 100,
                scrollCollapse: true,
                paging: false,
                lengthChange: false
            } );
            <!-- wire up the search box in template header  -->
            $('#search').on( 'keyup', function () {
                <!-- set table variable to the active/displayed table on page -->
                //~ table.search( this.value ).draw();
                $($.fn.dataTable.tables(true)).DataTable().search( this.value ).draw();
            } );

            $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
                $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust().draw();
            });
        } );
    </script>
  </body>
</html>
