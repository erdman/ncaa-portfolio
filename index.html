<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- datatables.net bootstrap4 styling -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">

    <!-- Custom styles for the large space filling tables, taken from an example on datatables.net -->
    <style type="text/css">
        #leaderboard_div {
            position: absolute;
            top: 3em;
            left: 1em;
            right: 1em;
            bottom: 1em;
        }

        #Summary {
            position: absolute;
            top: 3em;
            left: 1em;
            right: 1em;
            bottom: 1em;
        }

        #Details {
            position: absolute;
            top: 3em;
            left: 1em;
            right: 1em;
            bottom: 1em;
        }

    </style>
  </head>
  <body>
    <div>
      <ul class="nav nav-pills nav-justified">
        <li class="nav-item">
            <a class="navbar-brand" href="#">NCAAportfolio.com</a>
        </li>
        <li class="nav-item">
            <a class='nav-link active' data-toggle="tab" href="#leaderboard_div">Leaderboard</a>
        </li>
        <li class="nav-item">
            <a class='nav-link' data-toggle="tab" href="#Summary">Summary</a>
        </li>
        <li class="nav-item">
            <a class='nav-link' data-toggle="tab" href="#Details">Details</a>
        </li>
        <li class="nav-item">
            <a class='nav-link' data-toggle="tab" href="#Champions">Champions</a>
        </li>
        <li class="nav-item">
<!--
          <a class="nav-link" data-toggle="tab" href="#Year">Year</a>
-->
          <select class="nav-link" style="float: right; background-color: white">
            <option>2017</option>
            <option>2016</option>
          </select>
        </li>
        <li class="nav-item">
            <form class="form-inline my-2 my-lg-0">
                <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search" id='search'>
            </form>
        </li>
      </ul>
    </div>

    <main role="main" class="tab-content">
        <div id="Summary" class="tab-pane fade in">
            <table id="summary_table" class="display nowrap table table-striped table-bordered" cellspacing="0" width="100%">
                <tfoot>
                    <tr>
                        <th>Name</th>
                        <th>Conference</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>10</th>
                        <th>11</th>
                        <th>12</th>
                        <th>13</th>
                        <th>14</th>
                        <th>15</th>
                        <th>16</th>
                        <th>Total</th>
                        <th>Units</th>
                        <th>Points / Unit</th>
                     </tr>
                </tfoot>
            </table>
        </div>
        <div id="Details" class="tab-pane fade in">
            <table id="details_table" class="display nowrap table table-striped table-bordered" cellspacing="0" width="100%">
                <tfoot>
                    <tr>
                        <th>Date</th>
                        <th>Week</th>
                        <th>Result</th>
                     </tr>
                </tfoot>
            </table>
        </div>
        <div id="Champions" class="tab-pane fade in">
            <table id="champions_table" class="display nowrap table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Champion</th>
                     </tr>
                </thead>

                <tbody>
                    <tr>
                        <td>2017</td>
                        <td>Travis Erdman</td>
                    </tr>
                    <tr>
                        <td>2016</td>
                        <td>Jason Kopka</td>
                    </tr>
                    <tr>
                        <td>2015</td>
                        <td>Travis Erdman</td>
                    </tr>
                    <tr>
                        <td>2014</td>
                        <td>Steve Schubert</td>
                    </tr>
                    <tr>
                        <td>2013</td>
                        <td>TJ Nolan</td>
                    </tr>
                    <tr>
                        <td>2012</td>
                        <td>Tony Andronaco</td>
                    </tr>
                    <tr>
                        <td>2011</td>
                        <td>TJ Nolan</td>
                    </tr>

                </tbody>
            </table>
        </div>

        <div id="leaderboard_div" class="tab-pane active fade in show" >
            <table id="leaderboard_table" class="display table table-striped table-bordered" cellspacing="0" width="100%"></table>
        </div>



    </main> <!-- /.container -->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
<!--
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
-->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/plug-ins/1.10.16/features/scrollResize/dataTables.scrollResize.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        'use strict';
        function _stringifyGame(winner, loser, game) {
             //~ a-tag syntax: <a href="https://www.w3schools.com">Visit W3Schools.com!</a>
            return `<a href="https://www.ncaa.com${game.url}">${(winner.teamRank > 0) ? '#' + winner.teamRank + ' ' : ''}${winner.nameRaw} ${winner.currentScore}, ${(loser.teamRank > 0) ? '#' + loser.teamRank + ' ' : ''}${loser.nameRaw} ${loser.currentScore}<\a>`;
        }
        function stringifyGame(game) {
            return (game.away.currentScore > game.home.currentScore) ? _stringifyGame(game.away, game.home, game) : _stringifyGame(game.home, game.away, game);
        }
        // win_points indexed on [WIN?][OPP FBS?]
        const win_points = {true: {true: 10, false: 0}, false: {true: 0, false: -10}};
        // top25_points indexed on [WIN?][RANKED BETTER?][ABS(RANK_HI - RANK_LO) unless win and oppo unranked then return 0]
        const top25_points = {true:  {false: [0,5,5,5,5,6,6,6,6,6,6,6,6,6,6,8,8,8,8,8,8,8,8,8,8,10], true: [0,4,4,4,4,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,0]},
                              false: {false: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],  true: [0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-3,-3,-3,-3,-3,-3,-5,-5,-5,-5,-5]}
        };
        function calculateScore(hero, villain, fbs_name_set, game, new_years_six) {
            let heroRank = hero.teamRank > 0 ? hero.teamRank : 26;
            let villainRank = villain.teamRank > 0 ? villain.teamRank : 26;
            let VILLAIN_FBS = fbs_name_set.has(villain.nameRaw);
            let score = {win: win_points[hero.currentScore > villain.currentScore][VILLAIN_FBS],
                         blowout: VILLAIN_FBS && (hero.currentScore - villain.currentScore >= 30) ? 2 : 0,
                         shutout: VILLAIN_FBS && villain.currentScore === 0 ? 4 : 0,
                         top25: top25_points[hero.currentScore > villain.currentScore][heroRank < villainRank][hero.currentScore > villain.currentScore && villainRank === 26 ? 0 : Math.abs(heroRank - villainRank)],
                         bowl:  (game.week === 16 && !new_years_six.championships.has(game.id) ? 10 : 0) +
                                (new_years_six.playoffs.has(game.id) ? 6 : 0) +
                                (new_years_six.new_years_fours.has(game.id) ? 3 : 0)
            };
            score.total = score.win + score.blowout + score.shutout + score.top25 + score.bowl;
            return score;
        }

        function displaySchool(school) {
            return `${school.name} (${school.points} / ${school.units})`
        }


        let games = [], portfolios = [];
        const weeks = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16];
        const year = 2017;

        let loaders = weeks.map(function (week) {
            return $.getJSON(`json/${year}/${year}${week.toString().padStart(2,'0')}.json`)
                .then(function (data) {
                    games.push(...data.map(function (game) {
                        game.week = week;
                        return game;
                    }));
                }, function () { // in case of error (ie file not found), just return as resolved ala https://stackoverflow.com/a/30219952
                    return $.Deferred().resolve({}).promise();
                }
            );
        });


        let fbs, fbs_name_set, new_years_six = {};

        loaders.push(
            $.getJSON('json/fbs-2017.json')
            .then(function (data) {
                fbs = data.reduce((obj, cur) => { return { ...obj, [cur.name]: { ...cur, games:[], points: 0 } }; }, {});  //convert array to object indexed by names
                fbs_name_set = new Set(data.map(x => x.name));
            })
        );

        loaders.push(
            $.getJSON('json/new-years-six.json')
            .then(function (data) {
                Object.keys(data).forEach(function(key) {
                    new_years_six[key] = new Set(data[key]);
                });
            })
        );

        loaders.push(
            $.getJSON('json/portfolios-2017.json')
            .then(function (data) {
                portfolios.push(...data.map(function (item) {
                    let result = {'name': item.Name};
                    delete item.Name;
                    result.schools = Object.values(item).filter(x => x.length > 0);
                    return result;
                }));
            })
        );


        $.when(...loaders
        ).then(function () {
            games.sort((a, b) => a.startDate.localeCompare(b.startDate));
            console.log('when...then');
            console.log(games.length);
            console.log(games);
            console.log(fbs_name_set);
            console.log(new_years_six);
            games.forEach(function(game) {
                // parse JSON integers and trim name strings
                game.home.teamRank = parseInt(game.home.teamRank, 10);
                game.home.currentScore = parseInt(game.home.currentScore, 10);
                game.home.nameRaw = game.home.nameRaw.trim();
                game.away.teamRank = parseInt(game.away.teamRank, 10);
                game.away.currentScore = parseInt(game.away.currentScore, 10);
                game.away.nameRaw = game.away.nameRaw.trim();
                game.id = parseInt(game.id, 10);
                game.score_string = stringifyGame(game);

                if (game.gameState === 'final') {
                    if (fbs_name_set.has(game.away.nameRaw)) {
                        let score = calculateScore(game.away, game.home, fbs_name_set, game, new_years_six);
                        score.date = game.startDate;
                        score.score_string = game.score_string;
                        fbs[game.away.nameRaw].games.push(score);
                        fbs[game.away.nameRaw].points += score.total;
                    }

                    if (fbs_name_set.has(game.home.nameRaw)) {
                        let score = calculateScore(game.home, game.away, fbs_name_set, game, new_years_six);
                        score.date = game.startDate;
                        score.score_string = game.score_string;
                        fbs[game.home.nameRaw].games.push(score);
                        fbs[game.home.nameRaw].points += score.total;
                    }
                }
            });
            console.log(fbs);
            portfolios.forEach(function (portfolio) {
                portfolio.points = portfolio.schools.map(school => fbs[school].points).reduce((a,b) => a + b);
                portfolio.schools.sort((a,b) => fbs[b].points - fbs[a].points);
            });
            portfolios.sort((a,b) => b.points - a.points);
            portfolios.forEach((portfolio, index) => {portfolio.rank = index + 1;});
            console.log(portfolios);

            $('#leaderboard_table').DataTable( {
                data: portfolios,
                columns: [
                    { "data": "rank", "title": "Rank", className: "text-center" },
                    { "data": "name", "title": "Name" },
                    { "data": "schools", "title": "Portfolio", "render": li => li.map(school => `${school} (${fbs[school].points} / ${fbs[school].units})`).join(', ') },
                    { "data": "points", "title": "Totals", "render": (data, type, row) => `${data} / ${row.schools.reduce((acc,school) => acc + fbs[school].units, 0)}` }
                    ],
                "dom": 'lrtip',         <!-- removes the native search input box-->
                scrollResize: true,
                scrollX: true,
                scrollY: 100,
                scrollCollapse: true,
                paging: false,
                lengthChange: false
            });

            $('#details_table').DataTable( {
                data: games.filter(game => game.gameState === 'final'),
                columns: [
                    { "data": "startDate", "title": "Date" },
                    { "data": "week", "title": "Week" },
                    { "data": "score_string", "title": "Result" }
                    ],
                "dom": 'lrtip',         <!-- removes the native search input box-->
                scrollResize: true,
                scrollX: true,
                scrollY: 100,
                scrollCollapse: true,
                paging: false,
                lengthChange: false
            });

            $('#summary_table').DataTable( {
                data: Object.keys(fbs).map(function (school) { return { 'name': school,
                                                                        'conference': fbs[school].conference,
                                                                        'weeklies': fbs[school].games.map(score => score.total),
                                                                        'points': fbs[school].points,
                                                                        'units':  fbs[school].units,
                                                                        'points-per':  fbs[school].points / fbs[school].units
                                                                            };
                                                                 }
                                               ),
                columns: [
                    { "data": "name", "title": "Name" },
                    { "data": "conference", "title": "Conference" },
                    { "data": "weeklies.0", "title": "1", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.1", "title": "2", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.2", "title": "3", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.3", "title": "4", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.4", "title": "5", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.5", "title": "6", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.6", "title": "7", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.7", "title": "8", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.8", "title": "9", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.9", "title": "10", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.10", "title": "11", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.11", "title": "12", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.12", "title": "13", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.13", "title": "14", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.14", "title": "15", className: "text-right", "defaultContent": "" },
                    { "data": "weeklies.15", "title": "16", className: "text-right", "defaultContent": "" },
                    { "data": "points", "title": "Total", className: "text-right" },
                    { "data": "units", "title": "Units", className: "text-right" },
                    { "data": "points-per", "title": "Points / Unit", className: "text-right", render: $.fn.dataTable.render.number( ',', '.', 2 ) }
                    ],
                "dom": 'lrtip',         <!-- removes the native search input box-->
                scrollResize: true,
                scrollX: true,
                scrollY: 100,
                scrollCollapse: true,
                paging: false,
                lengthChange: false
            });
        });

        $(document).ready( function () {
            <!-- wire up the search box in template header  -->
            $('#search').on( 'keyup', function () {
                <!-- set table variable to the active/displayed table on page -->
                //~ table.search( this.value ).draw();
                $($.fn.dataTable.tables(true)).DataTable().search( this.value ).draw();
            } );
            <!-- adjust and redraw each tab's table when the tab is toggled (?) -->
            $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
                $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust().draw();
            });
        } );
    </script>
  </body>
</html>
